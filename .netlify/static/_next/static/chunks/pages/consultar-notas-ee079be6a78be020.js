(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4024],{3691:function(o,a,e){(window.__NEXT_P=window.__NEXT_P||[]).push(["/consultar-notas",function(){return e(1470)}])},1470:function(o,a,e){"use strict";e.r(a);var r=e(5893),t=e(7294),s=e(8426),n=e(3490),l=e(6788),i=e(8864),c=e(492),d=e(8690),h=e(2857),u=e(5026),p=e(6592),g=e(360),m=e(6577),x=e(8863),j=e(9827),f=e(7182),v=e(1873),w=e(6786),C=e(5821),E=e(3947),y=e(5659),Z=e(6558);a.default=()=>{let[o,a]=(0,t.useState)({status:"TODAS"}),[e,S]=(0,t.useState)(0),[b,N]=(0,t.useState)(10),[P,I]=(0,t.useState)(!0),{notas:T,fetchNotas:O}=(0,y.o)();(0,t.useEffect)(()=>{D()},[o]);let D=async()=>{I(!0);try{await O(o.dataInicio,o.dataFim)}catch(o){console.error("Erro ao carregar notas:",o)}finally{I(!1)}},z=o=>{alert("Excluir nota com id: ".concat(o))},A=T.filter(a=>(!o.numeroNota||!!a.numeroNota.includes(o.numeroNota))&&(!o.codigo||!!a.codigo.includes(o.codigo))&&("DISPONIVEIS"!==o.status||!a.controleId)&&("VINCULADAS"!==o.status||!!a.controleId)),k=A.slice(e*b,e*b+b);return(0,r.jsxs)(s.Z,{maxWidth:"lg",sx:{mt:4,mb:4},children:[(0,r.jsxs)(n.Z,{sx:{mb:4},children:[(0,r.jsx)(l.Z,{variant:"h4",component:"h1",gutterBottom:!0,children:"Consulta de Notas Fiscais"}),(0,r.jsx)(l.Z,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Consulte e filtre as notas fiscais cadastradas no sistema"})]}),(0,r.jsx)(i.Z,{sx:{p:3,mb:3},elevation:3,children:(0,r.jsxs)(n.Z,{sx:{display:"flex",flexWrap:"wrap",gap:2,mb:2},children:[(0,r.jsx)(c.Z,{label:"N\xfamero da Nota",size:"small",value:o.numeroNota||"",onChange:e=>a({...o,numeroNota:e.target.value}),sx:{minWidth:200}}),(0,r.jsx)(c.Z,{label:"C\xf3digo",size:"small",value:o.codigo||"",onChange:e=>a({...o,codigo:e.target.value}),sx:{minWidth:200}}),(0,r.jsx)(c.Z,{label:"Data In\xedcio",type:"date",size:"small",InputLabelProps:{shrink:!0},value:o.dataInicio||"",onChange:e=>a({...o,dataInicio:e.target.value})}),(0,r.jsx)(c.Z,{label:"Data Fim",type:"date",size:"small",InputLabelProps:{shrink:!0},value:o.dataFim||"",onChange:e=>a({...o,dataFim:e.target.value})}),(0,r.jsxs)(c.Z,{select:!0,label:"Status",size:"small",value:o.status||"TODAS",onChange:e=>{a({...o,status:e.target.value})},sx:{minWidth:150},SelectProps:{native:!0},children:[(0,r.jsx)("option",{value:"TODAS",children:"Todas"}),(0,r.jsx)("option",{value:"DISPONIVEIS",children:"Dispon\xedveis"}),(0,r.jsx)("option",{value:"VINCULADAS",children:"Vinculadas"})]}),(0,r.jsxs)(n.Z,{sx:{display:"flex",gap:1,ml:"auto"},children:[(0,r.jsx)(d.Z,{title:"Limpar filtros",children:(0,r.jsx)(h.Z,{onClick:()=>a({status:"TODAS"}),color:"primary",children:(0,r.jsx)(C.Z,{})})}),(0,r.jsx)(d.Z,{title:"Atualizar",children:(0,r.jsx)(h.Z,{onClick:D,color:"primary",disabled:P,children:(0,r.jsx)(E.Z,{})})})]})]})}),(0,r.jsxs)(i.Z,{sx:{width:"100%",mb:2},elevation:3,children:[(0,r.jsx)(u.Z,{children:(0,r.jsxs)(p.Z,{size:"small",children:[(0,r.jsx)(g.Z,{children:(0,r.jsxs)(m.Z,{children:[(0,r.jsx)(x.Z,{children:"N\xfamero da Nota"}),(0,r.jsx)(x.Z,{children:"C\xf3digo"}),(0,r.jsx)(x.Z,{align:"right",children:"Volumes"}),(0,r.jsx)(x.Z,{children:"Data de Cria\xe7\xe3o"}),(0,r.jsx)(x.Z,{children:"Status"}),(0,r.jsx)(x.Z,{children:"Controle"}),(0,r.jsx)(x.Z,{children:"A\xe7\xf5es"})]})}),(0,r.jsx)(j.Z,{children:P?(0,r.jsx)(m.Z,{children:(0,r.jsx)(x.Z,{colSpan:6,align:"center",sx:{py:4},children:(0,r.jsx)(f.Z,{})})}):0===k.length?(0,r.jsx)(m.Z,{children:(0,r.jsx)(x.Z,{colSpan:6,align:"center",sx:{py:4},children:"Nenhuma nota encontrada com os filtros atuais."})}):k.map(o=>(0,r.jsxs)(m.Z,{hover:!0,children:[(0,r.jsx)(x.Z,{children:o.numeroNota}),(0,r.jsx)(x.Z,{children:o.codigo}),(0,r.jsx)(x.Z,{align:"right",children:o.volumes||"1"}),(0,r.jsx)(x.Z,{children:(0,Z.Z)(new Date(o.dataCriacao))}),(0,r.jsx)(x.Z,{children:o.controleId?(0,r.jsx)(v.Z,{label:"Vinculada",color:"success",size:"small"}):(0,r.jsx)(v.Z,{label:"Dispon\xedvel",color:"warning",size:"small",variant:"outlined"})}),(0,r.jsx)(x.Z,{children:o.controle?(0,r.jsx)(d.Z,{title:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:["N\xba: ",o.controle.numeroManifesto||"N/A"]}),(0,r.jsxs)("div",{children:["Motorista: ",o.controle.motorista]}),(0,r.jsxs)("div",{children:["Respons\xe1vel: ",o.controle.responsavel]}),(0,r.jsxs)("div",{children:["Transportadora: ",o.controle.transportadora]}),(0,r.jsxs)("div",{children:["Data: ",new Date(o.controle.dataCriacao).toLocaleString()]})]}),arrow:!0,children:(0,r.jsx)(v.Z,{label:"".concat(o.controle.numeroManifesto||o.controle.id.substring(0,8)),size:"small",variant:"outlined",sx:{cursor:"pointer"}})}):"-"}),(0,r.jsx)(x.Z,{children:!o.controleId&&(0,r.jsx)(d.Z,{title:"Excluir Nota",children:(0,r.jsx)(h.Z,{color:"error",onClick:()=>z(o.id),children:(0,r.jsx)("span",{className:"material-icons",children:"delete"})})})})]},o.id))})]})}),(0,r.jsx)(w.Z,{rowsPerPageOptions:[5,10,25],component:"div",count:A.length,rowsPerPage:b,page:e,onPageChange:(o,a)=>{S(a)},onRowsPerPageChange:o=>{N(parseInt(o.target.value,10)),S(0)},labelRowsPerPage:"Linhas por p\xe1gina:",labelDisplayedRows:o=>{let{from:a,to:e,count:r}=o;return"".concat(a,"-").concat(e," de ").concat(-1!==r?r:"mais de ".concat(e))}})]})]})}},5659:function(o,a,e){"use strict";e.d(a,{o:function(){return r}});let r=(0,e(4529).Ue)(o=>({notas:[],controles:[],transportadoras:[],status:null,loading:!1,fetchNotas:async(a,e)=>{let r=new URLSearchParams;a&&r.append("start",a),e&&r.append("end",e);let t=await fetch("/api/notas".concat(r.toString()?"?"+r.toString():""),{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});o({notas:await t.json()})},fetchControles:async()=>{console.log("Iniciando fetchControles..."),o({loading:!0});try{let a=await fetch("/api/controles",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(console.log("Resposta do fetchControles recebida, status:",a.status),!a.ok){console.error("Erro ao buscar controles:",a.status,a.statusText);let o=await a.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao buscar controles")}let e=await a.json();console.log("Controles carregados com sucesso, quantidade:",e.length),o({controles:e,loading:!1})}catch(a){throw console.error("Erro em fetchControles:",a),o({loading:!1}),a}},fetchTransportadoras:async()=>{o({loading:!0});try{let a=await fetch("/api/transportadoras",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!a.ok){let o=await a.json().catch(()=>({}));throw Error(o.error||"Erro ao buscar transportadoras")}let e=await a.json();return o({transportadoras:e,loading:!1}),e}catch(a){throw console.error("Erro ao buscar transportadoras:",a),o({loading:!1}),a}},addNota:async a=>{try{if(console.log("Dados sendo enviados:",a),!(await fetch("/api/auth/me",{credentials:"include"})).ok)throw Error("Usu\xe1rio n\xe3o autenticado");let e=await fetch("/api/addNota",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify(a)});if(console.log("Status da resposta:",e.status),401===e.status)throw window.dispatchEvent(new Event("unauthorized")),Error("Sess\xe3o expirada. Por favor, fa\xe7a login novamente.");if(!e.ok){let o;try{o=await e.json(),console.error("Detalhes do erro:",o)}catch(a){o=await e.text()}let a="object"==typeof o?o.error||o.message||"Erro desconhecido":o||"Erro ao processar a requisi\xe7\xe3o";throw Error("Erro ao salvar nota: ".concat(e.status," - ").concat(a))}let r=await e.json();return o(o=>({notas:[...o.notas,r],status:"success"})),r}catch(a){throw console.error("Erro ao adicionar nota:",a),o(o=>({...o,status:"error"})),(a.message.includes("n\xe3o autenticado")||a.message.includes("Sess\xe3o expirada"))&&window.dispatchEvent(new Event("unauthorized")),a}},criarControle:async a=>{try{var e,r;let t;if(console.log("[criarControle] Dados recebidos:",JSON.stringify(a,null,2)),!(null===(e=a.motorista)||void 0===e?void 0:e.trim()))throw Error("Nome do motorista \xe9 obrigat\xf3rio");if(!(null===(r=a.responsavel)||void 0===r?void 0:r.trim()))throw Error("Nome do respons\xe1vel \xe9 obrigat\xf3rio");if(console.log("[criarControle] Transportadora recebida:",a.transportadora),!["ACERT","EXPRESSO_GOIAS"].includes(a.transportadora))throw console.error("[criarControle] Transportadora inv\xe1lida:",a.transportadora),Error("Transportadora inv\xe1lida. Valor recebido: "+a.transportadora);let s=Array.isArray(a.notasIds)?a.notasIds:[],n={...a,motorista:a.motorista.trim(),responsavel:a.responsavel.trim(),cpfMotorista:a.cpfMotorista?a.cpfMotorista.replace(/[^\d]/g,""):"PENDENTE",qtdPallets:Number(a.qtdPallets)||0,observacao:a.observacao||null,notasIds:s};console.log("[criarControle] Dados formatados para envio:",JSON.stringify(n,null,2)),console.log("[criarControle] Enviando requisi\xe7\xe3o para /api/controles");let l=await fetch("/api/controles",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(n)});console.log("[criarControle] Resposta recebida. Status:",l.status);try{t=await l.json(),console.log("[criarControle] Corpo da resposta:",JSON.stringify(t,null,2))}catch(o){console.error("[criarControle] Erro ao fazer parse da resposta:",o),t={}}if(!l.ok){console.error("[criarControle] Erro na resposta da API. Status:",l.status),console.error("[criarControle] Dados do erro:",t);let o=t.error||t.message||"Erro ao criar controle: ".concat(l.status," ").concat(l.statusText);throw console.error("[criarControle] Mensagem de erro:",o),Error(o)}let i=t;if(s.length>0)try{let o=await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({controleId:i.id,notasIds:s})});if(!o.ok){let a=await o.json().catch(()=>({}));console.warn("Aviso ao vincular notas:",a)}i.notas=s.map(o=>({id:o}))}catch(o){console.error("Erro ao vincular notas:",o)}try{let a=await fetch("/api/controles",{credentials:"include",headers:{Accept:"application/json"}});if(a.ok){let e=await a.json();o({controles:e})}}catch(o){console.error("Erro ao atualizar lista de controles:",o)}return i}catch(o){if(console.error("Erro na fun\xe7\xe3o criarControle:",o),o instanceof Error)throw o;throw Error("Erro desconhecido ao criar controle")}},vincularNotas:async(o,a)=>{await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o,notasIds:a})}),await Promise.all([r.getState().fetchNotas(),r.getState().fetchControles()])},finalizarControle:async o=>{await fetch("/api/controles/finalizar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o})}),await r.getState().fetchControles()},atualizarControle:async(o,a)=>{console.log("Iniciando atualizarControle...");try{console.log("Enviando requisi\xe7\xe3o para /api/controles/atualizar com dados:",{controleId:o,...a,qtdPallets:Number(a.qtdPallets)||0});let e=await fetch("/api/controles/atualizar",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({controleId:o,...a,qtdPallets:Number(a.qtdPallets)||0})});if(console.log("Resposta recebida, status:",e.status),!e.ok){console.error("Erro na resposta da API:",e.status,e.statusText);let o=await e.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao atualizar controle")}console.log("Atualizando lista de controles...");let t=await e.json();return await r.getState().fetchControles(),console.log("Controle atualizado com sucesso:",t),t}catch(o){return console.error("Erro ao atualizar controle:",o),null}}}))}},function(o){o.O(0,[8426,492,8690,4424,1873,2426,2888,9774,179],function(){return o(o.s=3691)}),_N_E=o.O()}]);