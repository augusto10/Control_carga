(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[516],{1449:function(o,r,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/vincular-notas",function(){return a(18)}])},18:function(o,r,a){"use strict";a.r(r);var e=a(5893),t=a(7294),n=a(5659),s=a(3490),l=a(7182),i=a(8426),c=a(6788),d=a(4677),u=a(8864),h=a(492),p=a(5972),m=a(5611),g=a(2857),f=a(7407),v=a(9304),C=a(2166),x=a(2200),j=a(1873),y=a(6912),w=a(3453),E=a(2365),b=a(110),Z=a(5858),S=a(6727),P=a(5299),N=a(4145),T=a(1163),z=a(9496),O=a(3902);r.default=()=>{let{enqueueSnackbar:o}=(0,z.Ds)(),r=(0,T.useRouter)(),{id:a}=r.query,{notas:A,controles:I,fetchNotas:M,fetchControles:k,vincularNotas:D,atualizarControle:R}=(0,n.o)(),[q,_]=(0,t.useState)([]),[F,W]=(0,t.useState)(""),J="string"==typeof a?a:"",[$,L]=(0,t.useState)(""),[X,B]=(0,t.useState)(""),[G,U]=(0,t.useState)(""),[V,H]=(0,t.useState)("ACERT"),[Q,K]=(0,t.useState)(""),[Y,oo]=(0,t.useState)(0),[or,oa]=(0,t.useState)(""),[oe,ot]=(0,t.useState)(!0),[on,os]=(0,t.useState)(!1),[ol,oi]=(0,t.useState)(!1),[oc,od]=(0,t.useState)({});(0,t.useEffect)(()=>{(async()=>{ot(!0);try{if(await Promise.all([M(),k()]),J){let o=I.find(o=>o.id===J);if(o){oi(!0),L(o.motorista||""),B(o.cpfMotorista||""),U(o.responsavel||""),H(o.transportadora||"ACERT"),K(o.numeroManifesto||""),oo(o.qtdPallets||0),oa(o.observacao||"");let r=o.notas.filter(o=>o.controleId===J).map(o=>o.id);_(r)}else oi(!1)}}catch(r){console.error("Erro ao carregar dados:",r),o("Erro ao carregar dados. Tente novamente.",{variant:"error",anchorOrigin:{vertical:"top",horizontal:"center"}})}finally{ot(!1)}})()},[J,M,k,I,o]);let ou=o=>{let r=q.indexOf(o),a=[...q];-1===r?a.push(o):a.splice(r,1),_(a)},oh=o=>{if(11!==(o=o.replace(/[\D]/g,"")).length)return{valido:!1,mensagem:"CPF deve ter 11 d\xedgitos"};if(/^(\d)\1+$/.test(o))return{valido:!1,mensagem:"CPF inv\xe1lido"};let r=0;for(let a=0;a<9;a++)r+=parseInt(o.charAt(a))*(10-a);let a=11-r%11;if((a>=10?0:a)!==parseInt(o.charAt(9)))return{valido:!1,mensagem:"CPF inv\xe1lido"};r=0;for(let a=0;a<10;a++)r+=parseInt(o.charAt(a))*(11-a);return((a=11-r%11)>=10?0:a)!==parseInt(o.charAt(10))?{valido:!1,mensagem:"CPF inv\xe1lido"}:{valido:!0}},op=o=>o.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})/,"$1-$2").replace(/(-\d{2})\d+?$/,"$1"),om=(0,t.useCallback)(o=>{let r=op(o.target.value);if(B(r),14===r.length){let o=oh(r);if(o.valido){let o={...oc};delete o.cpfMotorista,od(o)}else od(r=>({...r,cpfMotorista:o.mensagem||"CPF inv\xe1lido"}))}else if(r.length>0)od(o=>({...o,cpfMotorista:"CPF incompleto"}));else{let o={...oc};delete o.cpfMotorista,od(o)}},[oc]),og=()=>{let o={};if($.trim()||(o.motorista="Motorista \xe9 obrigat\xf3rio"),G.trim()||(o.responsavel="Respons\xe1vel \xe9 obrigat\xf3rio"),X.trim()){let r=oh(X);r.valido||(o.cpfMotorista=r.mensagem||"CPF inv\xe1lido")}else o.cpfMotorista="CPF \xe9 obrigat\xf3rio";return od(o),0===Object.keys(o).length},of=async()=>{try{return await R(J,{motorista:$.trim(),responsavel:G.trim(),cpfMotorista:X.replace(/\D/g,""),transportadora:V,numeroManifesto:Q,qtdPallets:Y,observacao:or.trim()}),q.length>0&&await D(J,q),!0}catch(r){return console.error("Erro ao atualizar controle:",r),o("Erro ao atualizar controle. Tente novamente.",{variant:"error",anchorOrigin:{vertical:"top",horizontal:"center"}}),!1}},ov=async()=>{try{let o=await R("",{motorista:$.trim(),responsavel:G.trim(),cpfMotorista:X.replace(/\D/g,""),transportadora:V,numeroManifesto:Q,qtdPallets:Y,observacao:or.trim()});return q.length>0&&(null==o?void 0:o.id)&&await D(o.id,q),!0}catch(r){return console.error("Erro ao criar controle:",r),o("Erro ao criar controle. Tente novamente.",{variant:"error",anchorOrigin:{vertical:"top",horizontal:"center"}}),!1}},oC=async()=>{os(!1),ot(!0);try{(J?await of():await ov())&&(o(J?"Controle atualizado com sucesso!":"Controle criado com sucesso!",{variant:"success",anchorOrigin:{vertical:"top",horizontal:"center"}}),r.push("/listar-controles"))}catch(r){console.error("Erro ao processar o formul\xe1rio:",r),o("Ocorreu um erro ao processar sua solicita\xe7\xe3o.",{variant:"error",anchorOrigin:{vertical:"top",horizontal:"center"}})}finally{ot(!1)}},ox=A.filter(o=>!F||o.numeroNota.toLowerCase().includes(F.toLowerCase())||o.codigo.toLowerCase().includes(F.toLowerCase()));return oe?(0,e.jsx)(s.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",children:(0,e.jsx)(l.Z,{})}):J&&!ol?(0,e.jsx)(i.Z,{maxWidth:"lg",children:(0,e.jsxs)(s.Z,{my:4,children:[(0,e.jsx)(c.Z,{variant:"h4",gutterBottom:!0,children:"Controle n\xe3o encontrado"}),(0,e.jsx)(d.Z,{variant:"contained",color:"primary",onClick:()=>r.push("/listar-controles"),children:"Voltar para a lista"})]})}):(0,e.jsxs)(i.Z,{maxWidth:"lg",children:[(0,e.jsxs)(s.Z,{my:4,children:[(0,e.jsx)(c.Z,{variant:"h4",gutterBottom:!0,children:J?"Editar Controle":"Novo Controle"}),(0,e.jsxs)(u.Z,{sx:{p:3,mb:3},children:[(0,e.jsx)(c.Z,{variant:"h6",gutterBottom:!0,children:"Dados do Motorista"}),(0,e.jsxs)(s.Z,{display:"flex",gap:2,flexWrap:"wrap",mb:2,children:[(0,e.jsx)(h.Z,{label:"Motorista",value:$,onChange:o=>L(o.target.value),fullWidth:!0,margin:"normal",error:!!oc.motorista,helperText:oc.motorista}),(0,e.jsx)(h.Z,{label:"CPF do Motorista",value:X,onChange:om,fullWidth:!0,margin:"normal",placeholder:"000.000.000-00",error:!!oc.cpfMotorista,helperText:oc.cpfMotorista,inputProps:{maxLength:14}}),(0,e.jsx)(h.Z,{label:"Respons\xe1vel",value:G,onChange:o=>U(o.target.value),fullWidth:!0,margin:"normal",error:!!oc.responsavel,helperText:oc.responsavel})]}),(0,e.jsxs)(s.Z,{display:"flex",gap:2,flexWrap:"wrap",mb:2,children:[(0,e.jsxs)(h.Z,{select:!0,label:"Transportadora",value:V,onChange:o=>H(o.target.value),fullWidth:!0,margin:"normal",children:[(0,e.jsx)(p.Z,{value:"ACERT",children:"ACERT"}),(0,e.jsx)(p.Z,{value:"EXPRESSO_GOIAS",children:"Expresso Goi\xe1s"})]}),(0,e.jsx)(h.Z,{label:"N\xfamero do Manifesto",value:Q,onChange:o=>K(o.target.value),fullWidth:!0,margin:"normal"}),(0,e.jsx)(h.Z,{label:"Quantidade de Pallets",type:"number",value:Y,onChange:o=>oo(Math.max(0,parseInt(o.target.value)||0)),fullWidth:!0,margin:"normal",InputProps:{inputProps:{min:0}}})]}),(0,e.jsx)(h.Z,{label:"Observa\xe7\xf5es",value:or,onChange:o=>oa(o.target.value),fullWidth:!0,multiline:!0,rows:3,margin:"normal"})]}),(0,e.jsxs)(u.Z,{sx:{p:3,mb:3},children:[(0,e.jsxs)(s.Z,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[(0,e.jsx)(c.Z,{variant:"h6",children:"Notas Fiscais"}),(0,e.jsxs)(s.Z,{display:"flex",gap:1,children:[(0,e.jsx)(d.Z,{variant:"outlined",startIcon:(0,e.jsx)(O.Z,{}),onClick:()=>{ot(!0),M().finally(()=>ot(!1))},disabled:oe,children:"Atualizar"}),(0,e.jsx)(h.Z,{placeholder:"Buscar nota...",value:F,onChange:o=>W(o.target.value),size:"small",InputProps:{startAdornment:(0,e.jsx)(m.Z,{position:"start",children:(0,e.jsx)(P.Z,{})}),endAdornment:F&&(0,e.jsx)(m.Z,{position:"end",children:(0,e.jsx)(g.Z,{size:"small",onClick:()=>W(""),edge:"end",children:(0,e.jsx)(N.Z,{fontSize:"small"})})})},sx:{minWidth:250}})]})]}),(0,e.jsx)(f.Z,{children:ox.length>0?ox.map(o=>(0,e.jsxs)(t.Fragment,{children:[(0,e.jsxs)(v.ZP,{children:[(0,e.jsx)(C.Z,{checked:q.includes(o.id),onChange:()=>ou(o.id),color:"primary"}),(0,e.jsx)(x.Z,{primary:"Nota: ".concat(o.numeroNota),secondary:"C\xf3digo: ".concat(o.codigo," | Volumes: ").concat(o.volumes||"1")}),o.controleId&&o.controleId!==J&&(0,e.jsx)(j.Z,{label:"J\xe1 vinculada",color:"warning",size:"small",sx:{ml:1}})]}),(0,e.jsx)(y.Z,{component:"li"})]},o.id)):(0,e.jsx)(v.ZP,{children:(0,e.jsx)(x.Z,{primary:"Nenhuma nota encontrada",secondary:F?"Tente ajustar sua busca":"Fa\xe7a uma busca para encontrar notas"})})})]}),(0,e.jsxs)(s.Z,{display:"flex",justifyContent:"flex-end",gap:2,children:[(0,e.jsx)(d.Z,{variant:"outlined",onClick:()=>r.push("/listar-controles"),children:"Cancelar"}),(0,e.jsx)(d.Z,{variant:"contained",color:"primary",onClick:()=>{if(!og()){o("Corrija os erros antes de salvar",{variant:"warning",anchorOrigin:{vertical:"top",horizontal:"center"}});return}os(!0)},disabled:oe,startIcon:oe?(0,e.jsx)(l.Z,{size:20}):null,children:J?"Atualizar":"Salvar"})]})]}),(0,e.jsxs)(w.Z,{open:on,onClose:()=>os(!1),children:[(0,e.jsx)(E.Z,{children:J?"Atualizar Controle?":"Criar Novo Controle?"}),(0,e.jsxs)(b.Z,{children:[(0,e.jsx)(Z.Z,{children:J?"Deseja realmente atualizar este controle com as altera\xe7\xf5es feitas?":"Deseja criar um novo controle com as informa\xe7\xf5es fornecidas?"}),q.length>0&&(0,e.jsxs)(s.Z,{mt:2,children:[(0,e.jsx)(c.Z,{variant:"subtitle2",children:"Notas selecionadas:"}),(0,e.jsxs)(c.Z,{variant:"body2",color:"text.secondary",children:[q.length," nota(s) ser\xe3o vinculadas a este controle."]})]})]}),(0,e.jsxs)(S.Z,{children:[(0,e.jsx)(d.Z,{onClick:()=>os(!1),children:"Cancelar"}),(0,e.jsx)(d.Z,{onClick:oC,color:"primary",variant:"contained",autoFocus:!0,disabled:oe,children:oe?"Salvando...":"Confirmar"})]})]})]})}},5659:function(o,r,a){"use strict";a.d(r,{o:function(){return e}});let e=(0,a(4529).Ue)(o=>({notas:[],controles:[],transportadoras:[],status:null,loading:!1,fetchNotas:async(r,a)=>{let e=new URLSearchParams;r&&e.append("start",r),a&&e.append("end",a);let t=await fetch("/api/notas".concat(e.toString()?"?"+e.toString():""),{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});o({notas:await t.json()})},fetchControles:async()=>{console.log("Iniciando fetchControles..."),o({loading:!0});try{let r=await fetch("/api/controles",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(console.log("Resposta do fetchControles recebida, status:",r.status),!r.ok){console.error("Erro ao buscar controles:",r.status,r.statusText);let o=await r.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao buscar controles")}let a=await r.json();console.log("Controles carregados com sucesso, quantidade:",a.length),o({controles:a,loading:!1})}catch(r){throw console.error("Erro em fetchControles:",r),o({loading:!1}),r}},fetchTransportadoras:async()=>{o({loading:!0});try{let r=await fetch("/api/transportadoras",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!r.ok){let o=await r.json().catch(()=>({}));throw Error(o.error||"Erro ao buscar transportadoras")}let a=await r.json();return o({transportadoras:a,loading:!1}),a}catch(r){throw console.error("Erro ao buscar transportadoras:",r),o({loading:!1}),r}},addNota:async r=>{try{if(console.log("Dados sendo enviados:",r),!(await fetch("/api/auth/me",{credentials:"include"})).ok)throw Error("Usu\xe1rio n\xe3o autenticado");let a=await fetch("/api/addNota",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify(r)});if(console.log("Status da resposta:",a.status),401===a.status)throw window.dispatchEvent(new Event("unauthorized")),Error("Sess\xe3o expirada. Por favor, fa\xe7a login novamente.");if(!a.ok){let o;try{o=await a.json(),console.error("Detalhes do erro:",o)}catch(r){o=await a.text()}let r="object"==typeof o?o.error||o.message||"Erro desconhecido":o||"Erro ao processar a requisi\xe7\xe3o";throw Error("Erro ao salvar nota: ".concat(a.status," - ").concat(r))}let e=await a.json();return o(o=>({notas:[...o.notas,e],status:"success"})),e}catch(r){throw console.error("Erro ao adicionar nota:",r),o(o=>({...o,status:"error"})),(r.message.includes("n\xe3o autenticado")||r.message.includes("Sess\xe3o expirada"))&&window.dispatchEvent(new Event("unauthorized")),r}},criarControle:async r=>{try{var a,e;let t;if(console.log("[criarControle] Dados recebidos:",JSON.stringify(r,null,2)),!(null===(a=r.motorista)||void 0===a?void 0:a.trim()))throw Error("Nome do motorista \xe9 obrigat\xf3rio");if(!(null===(e=r.responsavel)||void 0===e?void 0:e.trim()))throw Error("Nome do respons\xe1vel \xe9 obrigat\xf3rio");if(console.log("[criarControle] Transportadora recebida:",r.transportadora),!["ACERT","EXPRESSO_GOIAS"].includes(r.transportadora))throw console.error("[criarControle] Transportadora inv\xe1lida:",r.transportadora),Error("Transportadora inv\xe1lida. Valor recebido: "+r.transportadora);let n=Array.isArray(r.notasIds)?r.notasIds:[],s={...r,motorista:r.motorista.trim(),responsavel:r.responsavel.trim(),cpfMotorista:r.cpfMotorista?r.cpfMotorista.replace(/[^\d]/g,""):"PENDENTE",qtdPallets:Number(r.qtdPallets)||0,observacao:r.observacao||null,notasIds:n};console.log("[criarControle] Dados formatados para envio:",JSON.stringify(s,null,2)),console.log("[criarControle] Enviando requisi\xe7\xe3o para /api/controles");let l=await fetch("/api/controles",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(s)});console.log("[criarControle] Resposta recebida. Status:",l.status);try{t=await l.json(),console.log("[criarControle] Corpo da resposta:",JSON.stringify(t,null,2))}catch(o){console.error("[criarControle] Erro ao fazer parse da resposta:",o),t={}}if(!l.ok){console.error("[criarControle] Erro na resposta da API. Status:",l.status),console.error("[criarControle] Dados do erro:",t);let o=t.error||t.message||"Erro ao criar controle: ".concat(l.status," ").concat(l.statusText);throw console.error("[criarControle] Mensagem de erro:",o),Error(o)}let i=t;if(n.length>0)try{let o=await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({controleId:i.id,notasIds:n})});if(!o.ok){let r=await o.json().catch(()=>({}));console.warn("Aviso ao vincular notas:",r)}i.notas=n.map(o=>({id:o}))}catch(o){console.error("Erro ao vincular notas:",o)}try{let r=await fetch("/api/controles",{credentials:"include",headers:{Accept:"application/json"}});if(r.ok){let a=await r.json();o({controles:a})}}catch(o){console.error("Erro ao atualizar lista de controles:",o)}return i}catch(o){if(console.error("Erro na fun\xe7\xe3o criarControle:",o),o instanceof Error)throw o;throw Error("Erro desconhecido ao criar controle")}},vincularNotas:async(o,r)=>{await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o,notasIds:r})}),await Promise.all([e.getState().fetchNotas(),e.getState().fetchControles()])},finalizarControle:async o=>{await fetch("/api/controles/finalizar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o})}),await e.getState().fetchControles()},atualizarControle:async(o,r)=>{console.log("Iniciando atualizarControle...");try{console.log("Enviando requisi\xe7\xe3o para /api/controles/atualizar com dados:",{controleId:o,...r,qtdPallets:Number(r.qtdPallets)||0});let a=await fetch("/api/controles/atualizar",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({controleId:o,...r,qtdPallets:Number(r.qtdPallets)||0})});if(console.log("Resposta recebida, status:",a.status),!a.ok){console.error("Erro na resposta da API:",a.status,a.statusText);let o=await a.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao atualizar controle")}console.log("Atualizando lista de controles...");let t=await a.json();return await e.getState().fetchControles(),console.log("Controle atualizado com sucesso:",t),t}catch(o){return console.error("Erro ao atualizar controle:",o),null}}}))}},function(o){o.O(0,[8426,492,4793,1873,869,2888,9774,179],function(){return o(o.s=1449)}),_N_E=o.O()}]);