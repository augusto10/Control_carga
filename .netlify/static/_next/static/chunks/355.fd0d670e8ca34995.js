"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[355],{355:function(a,o,r){r.r(o);var e=r(5893),t=r(7294),n=r(5659),s=r(3490),l=r(7182),i=r(8426),c=r(6788),d=r(4677),h=r(8864),u=r(5026),p=r(6592),x=r(360),g=r(6577),m=r(8863),f=r(9827),v=r(1873),w=r(3453),y=r(2365),j=r(110),C=r(492),E=r(6897),b=r(8649),Z=r(5083),z=r(5972),T=r(6727),S=r(1163),P=r(2874),N=r(9496),k=r(4395),D=r(7952),O=r(9495);o.default=()=>{var a,o,r,R,A,M;let{user:q}=(0,P.aC)(),{controles:I,fetchControles:F,finalizarControle:W,atualizarControle:L}=(0,n.o)(),J=(0,S.useRouter)(),{enqueueSnackbar:H}=(0,N.Ds)(),[B,U]=t.useState(!1),[_,V]=t.useState(null),[X,G]=t.useState({}),[Q,K]=t.useState(null),[Y,$]=t.useState(!1);(0,t.useEffect)(()=>{(async()=>{try{U(!0),await F()}catch(a){console.error("Erro ao carregar controles:",a),H("Erro ao carregar controles",{variant:"error"})}finally{U(!1)}})()},[F,H]);let aa=async(a,o)=>{try{let o=await fetch("/templates/modelo-romaneio.pdf").then(a=>a.arrayBuffer()),r=await O.PDFDocument.load(o),e=r.getPage(0),{width:t,height:n}=e.getSize(),s=await r.embedFont(O.StandardFonts.Helvetica),l=n-50,i=new Date().toLocaleDateString("pt-BR"),c=new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});l-=108,e.drawText("Transportadora: ".concat(a.transportadora),{x:50,y:l,size:10,font:s}),e.drawText("Usu\xe1rio: ".concat(a.responsavel||"-"),{x:250,y:l,size:10,font:s}),l-=27,e.drawText("Placa Ve\xedculo: -",{x:50,y:l,size:10,font:s}),e.drawText("Nome Motorista: ".concat(a.motorista||"-"),{x:250,y:l,size:10,font:s}),l-=27,e.drawText("CPF Motorista: ".concat(a.cpfMotorista||"-"),{x:50,y:l,size:10,font:s}),e.drawText("Hor\xe1rio: ".concat(c),{x:250,y:l,size:10,font:s}),l-=27,e.drawText("Quantidade de Pallets: ".concat(a.qtdPallets||"0"),{x:50,y:l,size:10,font:s}),e.drawText("Data: ".concat(i),{x:250,y:l,size:10,font:s});let d=l-=36;e.drawText("Qtd",{x:50,y:d,size:10,font:s,color:(0,O.rgb)(0,0,0)}),e.drawText("Nota Fiscal",{x:80,y:d,size:10,font:s,color:(0,O.rgb)(0,0,0)}),e.drawText("Data",{x:150,y:d,size:10,font:s,color:(0,O.rgb)(0,0,0)}),e.drawText("Volumes",{x:250,y:d,size:10,font:s,color:(0,O.rgb)(0,0,0)}),l-=5,e.drawLine({start:{x:50,y:l},end:{x:t-50,y:l},thickness:1,color:(0,O.rgb)(0,0,0)}),l-=25;let h=0;a.notas.forEach((a,o)=>{l<100&&(e.drawText("Continua na pr\xf3xima p\xe1gina...",{x:50,y:50,size:8,font:s,color:(0,O.rgb)(.5,.5,.5)}),l=n-50);let r=parseInt(a.volumes)||1;h+=r;let t=a.dataCriacao?new Date(a.dataCriacao).toLocaleDateString("pt-BR"):"-";e.drawText((o+1).toString(),{x:50,y:l,size:10,font:s}),e.drawText(a.numeroNota||"-",{x:80,y:l,size:10,font:s}),e.drawText(t,{x:150,y:l,size:10,font:s}),e.drawText(r.toString(),{x:250,y:l,size:10,font:s}),l-=18}),l-=18,e.drawLine({start:{x:50,y:l},end:{x:t-50,y:l},thickness:1,color:(0,O.rgb)(0,0,0)}),l-=18,e.drawText("TOTAL:",{x:80,y:l,size:10,font:s,color:(0,O.rgb)(0,0,0)}),e.drawText(a.notas.length.toString(),{x:50,y:l,size:10,font:s,color:(0,O.rgb)(0,0,0)}),e.drawText(h.toString(),{x:250,y:l,size:10,font:s,color:(0,O.rgb)(0,0,0)}),l-=36,e.drawText("N\xba Controle: ".concat(a.numeroManifesto||"-"),{x:50,y:l,size:9,font:s}),e.drawText("Total de Volumes: ".concat(h),{x:250,y:l,size:9,font:s});let u=await r.save(),p=new Blob([u],{type:"application/pdf"}),x=URL.createObjectURL(p);K(x),$(!0)}catch(a){console.error("Erro ao gerar PDF:",a),H("Erro ao gerar PDF",{variant:"error"})}},ao=a=>!a.finalizado||(null==q?void 0:q.tipo)==="GERENTE"||(null==q?void 0:q.tipo)==="ADMIN",ar=a=>{var o,r;V(a),G({motorista:a.motorista,responsavel:a.responsavel,cpfMotorista:null!==(o=a.cpfMotorista)&&void 0!==o?o:"",transportadora:a.transportadora,qtdPallets:a.qtdPallets,observacao:null!==(r=a.observacao)&&void 0!==r?r:""})},ae=()=>{V(null),G({})},at=async()=>{if(_)try{await L(_.id,X),H("Controle atualizado com sucesso",{variant:"success"}),ae()}catch(a){H("Erro ao atualizar controle",{variant:"error"})}},an=async a=>{try{await W(a),H("Controle finalizado com sucesso!",{variant:"success"})}catch(a){console.error("Erro ao finalizar controle:",a),H("Erro ao finalizar controle",{variant:"error"})}};return B?(0,e.jsx)(s.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",children:(0,e.jsx)(l.Z,{})}):(0,e.jsxs)(i.Z,{maxWidth:"lg",sx:{mt:4,mb:4},children:[(0,e.jsxs)(s.Z,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[(0,e.jsx)(c.Z,{variant:"h4",component:"h1",children:"Controles de Carga"}),(0,e.jsx)(d.Z,{variant:"contained",color:"primary",onClick:()=>J.push("/criar-controle"),children:"Novo Controle"})]}),(0,e.jsx)(h.Z,{sx:{width:"100%",overflow:"hidden"},children:(0,e.jsx)(u.Z,{sx:{maxHeight:600},children:(0,e.jsxs)(p.Z,{stickyHeader:!0,"aria-label":"tabela de controles",children:[(0,e.jsx)(x.Z,{children:(0,e.jsxs)(g.Z,{children:[(0,e.jsx)(m.Z,{children:"N\xba"}),(0,e.jsx)(m.Z,{children:"Data"}),(0,e.jsx)(m.Z,{children:"Motorista"}),(0,e.jsx)(m.Z,{children:"Respons\xe1vel"}),(0,e.jsx)(m.Z,{children:"Notas"}),(0,e.jsx)(m.Z,{children:"Status"}),(0,e.jsx)(m.Z,{align:"right",children:"A\xe7\xf5es"})]})}),(0,e.jsx)(f.Z,{children:I.map((a,o)=>{var r;return(0,e.jsxs)(g.Z,{hover:!0,children:[(0,e.jsx)(m.Z,{children:a.numeroManifesto||"N/A"}),(0,e.jsx)(m.Z,{children:(0,k.Z)(new Date(a.dataCriacao),"dd/MM/yyyy HH:mm",{locale:D.Z})}),(0,e.jsx)(m.Z,{children:a.motorista}),(0,e.jsx)(m.Z,{children:a.responsavel}),(0,e.jsxs)(m.Z,{children:[(null===(r=a.notas)||void 0===r?void 0:r.length)||0," nota(s)"]}),(0,e.jsx)(m.Z,{children:(0,e.jsx)(v.Z,{label:a.finalizado?"Finalizado":"Em andamento",color:a.finalizado?"success":"default",size:"small"})}),(0,e.jsx)(m.Z,{align:"right",children:(0,e.jsxs)(s.Z,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[(0,e.jsx)(d.Z,{variant:"outlined",size:"small",onClick:()=>J.push("/controle/".concat(a.id)),children:"Ver"}),(0,e.jsx)(d.Z,{variant:"outlined",size:"small",onClick:()=>aa(a,o+1),children:"PDF"}),ao(a)&&(0,e.jsx)(d.Z,{variant:"outlined",size:"small",onClick:()=>ar(a),children:"Editar"}),!a.finalizado&&(0,e.jsx)(d.Z,{variant:"contained",color:"primary",size:"small",onClick:()=>an(a.id),children:"Finalizar"})]})})]},a.id)})})]})})}),_&&(0,e.jsxs)(w.Z,{open:!0,onClose:ae,maxWidth:"sm",fullWidth:!0,children:[(0,e.jsx)(y.Z,{children:"Editar Controle"}),(0,e.jsxs)(j.Z,{dividers:!0,children:[(0,e.jsx)(C.Z,{margin:"normal",fullWidth:!0,label:"Motorista",value:null!==(a=X.motorista)&&void 0!==a?a:"",onChange:a=>G({...X,motorista:a.target.value})}),(0,e.jsx)(C.Z,{margin:"normal",fullWidth:!0,label:"Respons\xe1vel",value:null!==(o=X.responsavel)&&void 0!==o?o:"",onChange:a=>G({...X,responsavel:a.target.value})}),(0,e.jsx)(C.Z,{margin:"normal",fullWidth:!0,label:"CPF Motorista",value:null!==(r=X.cpfMotorista)&&void 0!==r?r:"",onChange:a=>G({...X,cpfMotorista:a.target.value})}),(0,e.jsxs)(E.Z,{fullWidth:!0,margin:"normal",children:[(0,e.jsx)(b.Z,{id:"transportadora-label",children:"Transportadora"}),(0,e.jsxs)(Z.Z,{labelId:"transportadora-label",value:null!==(R=X.transportadora)&&void 0!==R?R:"ACERT",label:"Transportadora",onChange:a=>G({...X,transportadora:a.target.value}),children:[(0,e.jsx)(z.Z,{value:"ACERT",children:"ACERT"}),(0,e.jsx)(z.Z,{value:"EXPRESSO_GOIAS",children:"EXPRESSO GOI\xc1S"})]})]}),(0,e.jsx)(C.Z,{margin:"normal",type:"number",fullWidth:!0,label:"Quantidade de Pallets",value:null!==(A=X.qtdPallets)&&void 0!==A?A:0,onChange:a=>G({...X,qtdPallets:Number(a.target.value)})}),(0,e.jsx)(C.Z,{margin:"normal",fullWidth:!0,multiline:!0,minRows:3,label:"Observa\xe7\xe3o",value:null!==(M=X.observacao)&&void 0!==M?M:"",onChange:a=>G({...X,observacao:a.target.value})})]}),(0,e.jsxs)(T.Z,{children:[(0,e.jsx)(d.Z,{onClick:ae,children:"Cancelar"}),(0,e.jsx)(d.Z,{variant:"contained",onClick:at,children:"Salvar"})]})]}),Q&&(0,e.jsxs)(w.Z,{open:Y,onClose:()=>$(!1),fullWidth:!0,maxWidth:"md",children:[(0,e.jsx)(y.Z,{children:"Pr\xe9-visualiza\xe7\xe3o do PDF"}),(0,e.jsx)(j.Z,{dividers:!0,sx:{height:600},children:(0,e.jsx)("iframe",{src:Q,width:"100%",height:"100%",style:{border:"none"}})}),(0,e.jsxs)(T.Z,{children:[(0,e.jsx)(d.Z,{onClick:()=>$(!1),children:"Fechar"}),(0,e.jsx)(d.Z,{onClick:()=>{let a=document.createElement("a");a.href=Q,a.download="romaneio.pdf",a.click()},children:"Baixar"}),navigator.share&&(0,e.jsx)(d.Z,{onClick:()=>{navigator.share({title:"Romaneio",url:Q})},children:"Compartilhar"})]})]})]})}},5659:function(a,o,r){r.d(o,{o:function(){return e}});let e=(0,r(4529).Ue)(a=>({notas:[],controles:[],transportadoras:[],status:null,loading:!1,fetchNotas:async(o,r)=>{let e=new URLSearchParams;o&&e.append("start",o),r&&e.append("end",r);let t=await fetch("/api/notas".concat(e.toString()?"?"+e.toString():""),{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});a({notas:await t.json()})},fetchControles:async()=>{console.log("Iniciando fetchControles..."),a({loading:!0});try{let o=await fetch("/api/controles",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(console.log("Resposta do fetchControles recebida, status:",o.status),!o.ok){console.error("Erro ao buscar controles:",o.status,o.statusText);let a=await o.json().catch(()=>({}));throw console.error("Detalhes do erro:",a),Error(a.error||"Erro ao buscar controles")}let r=await o.json();console.log("Controles carregados com sucesso, quantidade:",r.length),a({controles:r,loading:!1})}catch(o){throw console.error("Erro em fetchControles:",o),a({loading:!1}),o}},fetchTransportadoras:async()=>{a({loading:!0});try{let o=await fetch("/api/transportadoras",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!o.ok){let a=await o.json().catch(()=>({}));throw Error(a.error||"Erro ao buscar transportadoras")}let r=await o.json();return a({transportadoras:r,loading:!1}),r}catch(o){throw console.error("Erro ao buscar transportadoras:",o),a({loading:!1}),o}},addNota:async o=>{try{if(console.log("Dados sendo enviados:",o),!(await fetch("/api/auth/me",{credentials:"include"})).ok)throw Error("Usu\xe1rio n\xe3o autenticado");let r=await fetch("/api/addNota",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify(o)});if(console.log("Status da resposta:",r.status),401===r.status)throw window.dispatchEvent(new Event("unauthorized")),Error("Sess\xe3o expirada. Por favor, fa\xe7a login novamente.");if(!r.ok){let a;try{a=await r.json(),console.error("Detalhes do erro:",a)}catch(o){a=await r.text()}let o="object"==typeof a?a.error||a.message||"Erro desconhecido":a||"Erro ao processar a requisi\xe7\xe3o";throw Error("Erro ao salvar nota: ".concat(r.status," - ").concat(o))}let e=await r.json();return a(a=>({notas:[...a.notas,e],status:"success"})),e}catch(o){throw console.error("Erro ao adicionar nota:",o),a(a=>({...a,status:"error"})),(o.message.includes("n\xe3o autenticado")||o.message.includes("Sess\xe3o expirada"))&&window.dispatchEvent(new Event("unauthorized")),o}},criarControle:async o=>{try{var r,e;let t;if(console.log("[criarControle] Dados recebidos:",JSON.stringify(o,null,2)),!(null===(r=o.motorista)||void 0===r?void 0:r.trim()))throw Error("Nome do motorista \xe9 obrigat\xf3rio");if(!(null===(e=o.responsavel)||void 0===e?void 0:e.trim()))throw Error("Nome do respons\xe1vel \xe9 obrigat\xf3rio");if(console.log("[criarControle] Transportadora recebida:",o.transportadora),!["ACERT","EXPRESSO_GOIAS"].includes(o.transportadora))throw console.error("[criarControle] Transportadora inv\xe1lida:",o.transportadora),Error("Transportadora inv\xe1lida. Valor recebido: "+o.transportadora);let n=Array.isArray(o.notasIds)?o.notasIds:[],s={...o,motorista:o.motorista.trim(),responsavel:o.responsavel.trim(),cpfMotorista:o.cpfMotorista?o.cpfMotorista.replace(/[^\d]/g,""):"PENDENTE",qtdPallets:Number(o.qtdPallets)||0,observacao:o.observacao||null,notasIds:n};console.log("[criarControle] Dados formatados para envio:",JSON.stringify(s,null,2)),console.log("[criarControle] Enviando requisi\xe7\xe3o para /api/controles");let l=await fetch("/api/controles",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(s)});console.log("[criarControle] Resposta recebida. Status:",l.status);try{t=await l.json(),console.log("[criarControle] Corpo da resposta:",JSON.stringify(t,null,2))}catch(a){console.error("[criarControle] Erro ao fazer parse da resposta:",a),t={}}if(!l.ok){console.error("[criarControle] Erro na resposta da API. Status:",l.status),console.error("[criarControle] Dados do erro:",t);let a=t.error||t.message||"Erro ao criar controle: ".concat(l.status," ").concat(l.statusText);throw console.error("[criarControle] Mensagem de erro:",a),Error(a)}let i=t;if(n.length>0)try{let a=await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({controleId:i.id,notasIds:n})});if(!a.ok){let o=await a.json().catch(()=>({}));console.warn("Aviso ao vincular notas:",o)}i.notas=n.map(a=>({id:a}))}catch(a){console.error("Erro ao vincular notas:",a)}try{let o=await fetch("/api/controles",{credentials:"include",headers:{Accept:"application/json"}});if(o.ok){let r=await o.json();a({controles:r})}}catch(a){console.error("Erro ao atualizar lista de controles:",a)}return i}catch(a){if(console.error("Erro na fun\xe7\xe3o criarControle:",a),a instanceof Error)throw a;throw Error("Erro desconhecido ao criar controle")}},vincularNotas:async(a,o)=>{await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:a,notasIds:o})}),await Promise.all([e.getState().fetchNotas(),e.getState().fetchControles()])},finalizarControle:async a=>{await fetch("/api/controles/finalizar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:a})}),await e.getState().fetchControles()},atualizarControle:async(a,o)=>{console.log("Iniciando atualizarControle...");try{console.log("Enviando requisi\xe7\xe3o para /api/controles/atualizar com dados:",{controleId:a,...o,qtdPallets:Number(o.qtdPallets)||0});let r=await fetch("/api/controles/atualizar",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({controleId:a,...o,qtdPallets:Number(o.qtdPallets)||0})});if(console.log("Resposta recebida, status:",r.status),!r.ok){console.error("Erro na resposta da API:",r.status,r.statusText);let a=await r.json().catch(()=>({}));throw console.error("Detalhes do erro:",a),Error(a.error||"Erro ao atualizar controle")}console.log("Atualizando lista de controles...");let t=await r.json();return await e.getState().fetchControles(),console.log("Controle atualizado com sucesso:",t),t}catch(a){return console.error("Erro ao atualizar controle:",a),null}}}))}}]);