"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2321],{2321:function(o,a,r){r.r(a);var t=r(5893),e=r(7294),s=r(5659),n=r(8426),l=r(3490),i=r(7182),c=r(8864),d=r(6788),u=r(492),p=r(6897),h=r(8649),m=r(5083),f=r(5972),g=r(2283),v=r(7407),C=r(9304),E=r(2166),y=r(2200),b=r(4677),x=r(1163),j=r(9496),w=r(4395),S=r(7952),P=r(2874);a.default=()=>{let o=(0,x.useRouter)(),{user:a}=(0,P.aC)(),{enqueueSnackbar:r}=(0,j.Ds)(),{transportadoras:N,fetchTransportadoras:T,criarControle:Z,loading:q,fetchNotas:O,notas:A}=(0,s.o)(o=>({transportadoras:o.transportadoras,fetchTransportadoras:o.fetchTransportadoras,criarControle:o.criarControle,loading:o.loading,fetchNotas:o.fetchNotas,notas:o.notas})),[D,I]=(0,e.useState)({transportadoras:!1,notas:!1,submit:!1}),R=[{id:"ACERT",nome:"ACERT",descricao:"ACERT"},{id:"EXPRESSO_GOIAS",nome:"EXPRESSO_GOIAS",descricao:"EXPRESSO GOI\xc1S"}],k=R.find(o=>"ACERT"===o.id),[M,z]=(0,e.useState)({motorista:"PENDENTE",cpfMotorista:"",transportadora:(null==k?void 0:k.id)||"ACERT",responsavel:"PENDENTE",observacao:"",qtdPallets:0});(0,e.useEffect)(()=>{(null==a?void 0:a.nome)&&z(o=>({...o,responsavel:a.nome}))},[a]);let[J,W]=(0,e.useState)({}),[H,_]=(0,e.useState)([]),X=Array.isArray(A)?A:[],G=X.filter(o=>!o.controleId);console.log("Todas as notas da store:",A),console.log("Notas dispon\xedveis (array):",X),console.log("Notas n\xe3o vinculadas:",G),(0,e.useEffect)(()=>{(async()=>{try{I(o=>({...o,transportadoras:!0,notas:!0})),await O()}catch(o){console.error("Erro ao carregar dados:",o),r("Erro ao carregar notas fiscais",{variant:"error"})}finally{I(o=>({...o,transportadoras:!1,notas:!1}))}})()},[O,r]);let B=o=>{let{name:a,value:r}=o.target;if("qtdPallets"===a){let o=parseInt(r)||0;z(r=>({...r,[a]:o}))}else z(o=>({...o,[a]:r}));J[a]&&W(o=>({...o,[a]:""}))},U=async a=>{a.preventDefault();try{var t,e,s;W({});let a={};if(M.transportadora||(a.transportadora="Transportadora \xe9 obrigat\xf3ria"),(null===(t=M.motorista)||void 0===t?void 0:t.trim())||(a.motorista="Nome do motorista \xe9 obrigat\xf3rio"),(null===(e=M.responsavel)||void 0===e?void 0:e.trim())||(a.responsavel="Nome do respons\xe1vel \xe9 obrigat\xf3rio"),M.qtdPallets<=0&&(a.qtdPallets="Quantidade de pallets deve ser maior que zero"),Object.keys(a).length>0){W(a),r("Corrija os erros no formul\xe1rio",{variant:"error",autoHideDuration:5e3});return}I(o=>({...o,submit:!0}));let n={motorista:(M.motorista||"PENDENTE").trim(),cpfMotorista:(M.cpfMotorista||"").trim(),responsavel:(M.responsavel||"PENDENTE").trim(),transportadora:M.transportadora,qtdPallets:Number(M.qtdPallets)||0,observacao:(null===(s=M.observacao)||void 0===s?void 0:s.trim())||void 0,notasIds:Array.isArray(H)?H:[]};console.log("Dados do controle formatados para envio:",JSON.stringify(n,null,2)),console.log("Dados do controle formatados para envio:",JSON.stringify(n,null,2)),console.log("Dados do controle antes do envio:",JSON.stringify(n,null,2)),console.log("[CriarControle] Dados do controle a serem enviados:",n);let l=await Z(n);console.log("[CriarControle] Controle criado com sucesso:",l),r("Controle criado com sucesso!",{variant:"success",autoHideDuration:3e3}),setTimeout(()=>{o.push("/listar-controles")},1e3)}catch(t){console.error("[CriarControle] Erro ao criar controle:",t);let a="Erro ao criar controle. Por favor, tente novamente.";t instanceof Error&&(t.message.includes("j\xe1 existe")?a="J\xe1 existe um controle com esses dados. Verifique as informa\xe7\xf5es e tente novamente.":t.message.includes("n\xe3o autenticado")||t.message.includes("Sess\xe3o expirada")?(a="Sua sess\xe3o expirou. Por favor, fa\xe7a login novamente.",setTimeout(()=>o.push("/login"),1500)):a=t.message||a),r(a,{variant:"error",autoHideDuration:7e3,persist:!1})}finally{I(o=>({...o,submit:!1}))}};return D.transportadoras||D.notas?(0,t.jsx)(n.Z,{maxWidth:"lg",sx:{mt:4,mb:4},children:(0,t.jsx)(l.Z,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",children:(0,t.jsx)(i.Z,{})})}):(0,t.jsx)(n.Z,{maxWidth:"md",sx:{mt:4,mb:4},children:(0,t.jsxs)(c.Z,{elevation:3,sx:{p:4},children:[(0,t.jsx)(d.Z,{variant:"h5",component:"h1",gutterBottom:!0,children:"Criar Novo Controle de Carga"}),(0,t.jsxs)(l.Z,{component:"form",onSubmit:U,sx:{mt:3},children:[(0,t.jsx)(d.Z,{variant:"h6",gutterBottom:!0,sx:{mt:2,mb:2},children:"Dados do Motorista"}),(0,t.jsxs)(l.Z,{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:2,children:[(0,t.jsx)(u.Z,{fullWidth:!0,label:"Respons\xe1vel",name:"responsavel",value:M.responsavel,onChange:B,error:!!J.responsavel,helperText:J.responsavel,margin:"normal",required:!0}),(0,t.jsx)(u.Z,{fullWidth:!0,label:"Motorista",name:"motorista",value:M.motorista,onChange:B,error:!!J.motorista,helperText:J.motorista,margin:"normal",required:!0}),(0,t.jsx)(u.Z,{fullWidth:!0,label:"CPF do Motorista",name:"cpfMotorista",value:M.cpfMotorista,onChange:B,error:!!J.cpfMotorista,helperText:J.cpfMotorista||"Apenas n\xfameros",margin:"normal",required:!0}),(0,t.jsxs)(p.Z,{fullWidth:!0,error:!!J.transportadora,children:[(0,t.jsx)(h.Z,{id:"transportadora-label",children:"Transportadora"}),(0,t.jsx)(m.Z,{labelId:"transportadora-label",id:"transportadora",name:"transportadora",value:M.transportadora,onChange:B,label:"Transportadora",children:R.map(o=>(0,t.jsx)(f.Z,{value:o.id,children:o.descricao},o.id))}),J.transportadora&&(0,t.jsx)(g.Z,{children:J.transportadora})]}),(0,t.jsx)(u.Z,{fullWidth:!0,label:"Quantidade de Pallets",name:"qtdPallets",type:"number",value:M.qtdPallets,onChange:o=>z({...M,qtdPallets:parseInt(o.target.value)||0}),error:!!J.qtdPallets,helperText:J.qtdPallets,margin:"normal",inputProps:{min:1},required:!0}),(0,t.jsx)(u.Z,{fullWidth:!0,label:"Observa\xe7\xf5es",name:"observacao",value:M.observacao,onChange:B,margin:"normal",multiline:!0,rows:4})]}),(0,t.jsx)(d.Z,{variant:"h6",gutterBottom:!0,sx:{mt:2,mb:2},children:"Notas Fiscais"}),0===X.length?(0,t.jsx)(d.Z,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:"Nenhuma nota fiscal dispon\xedvel para vincular."}):(0,t.jsx)(v.Z,{dense:!0,sx:{maxHeight:300,overflow:"auto"},children:G.map(o=>(0,t.jsxs)(C.ZP,{button:!0,onClick:()=>{_(a=>a.includes(o.id)?a.filter(a=>a!==o.id):[...a,o.id])},sx:{"&:hover":{backgroundColor:"action.hover"},backgroundColor:H.includes(o.id)?"action.selected":"transparent",borderRadius:1,mb:.5},children:[(0,t.jsx)(E.Z,{edge:"start",checked:H.includes(o.id),tabIndex:-1,disableRipple:!0,inputProps:{"aria-labelledby":"nota-".concat(o.id)}}),(0,t.jsx)(y.Z,{id:"nota-".concat(o.id),primary:"Nota ".concat(o.numeroNota," - ").concat(o.volumes," volume").concat(1!==parseInt(o.volumes)?"s":""),secondary:"C\xf3digo: ".concat(o.codigo," â€¢ Data: ").concat((0,w.Z)(new Date(o.dataCriacao),"dd/MM/yyyy HH:mm",{locale:S.Z}))})]},o.id))}),H.length>0&&(0,t.jsxs)(d.Z,{variant:"body2",color:"textSecondary",sx:{mt:1,fontStyle:"italic"},children:[H.length," nota(s) selecionada(s)"]}),(0,t.jsxs)(l.Z,{sx:{mt:4,display:"flex",justifyContent:"flex-end",gap:2},children:[(0,t.jsx)(b.Z,{variant:"outlined",onClick:()=>o.push("/"),disabled:D.transportadoras||D.notas,children:"Cancelar"}),(0,t.jsx)(b.Z,{type:"submit",variant:"contained",color:"primary",disabled:D.submit,startIcon:D.submit?(0,t.jsx)(i.Z,{size:20}):null,children:D.submit?"Salvando...":"Criar Controle"})]})]})]})})}},5659:function(o,a,r){r.d(a,{o:function(){return t}});let t=(0,r(4529).Ue)(o=>({notas:[],controles:[],transportadoras:[],status:null,loading:!1,fetchNotas:async(a,r)=>{let t=new URLSearchParams;a&&t.append("start",a),r&&t.append("end",r);let e=await fetch("/api/notas".concat(t.toString()?"?"+t.toString():""),{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});o({notas:await e.json()})},fetchControles:async()=>{console.log("Iniciando fetchControles..."),o({loading:!0});try{let a=await fetch("/api/controles",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(console.log("Resposta do fetchControles recebida, status:",a.status),!a.ok){console.error("Erro ao buscar controles:",a.status,a.statusText);let o=await a.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao buscar controles")}let r=await a.json();console.log("Controles carregados com sucesso, quantidade:",r.length),o({controles:r,loading:!1})}catch(a){throw console.error("Erro em fetchControles:",a),o({loading:!1}),a}},fetchTransportadoras:async()=>{o({loading:!0});try{let a=await fetch("/api/transportadoras",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},credentials:"include"});if(!a.ok){let o=await a.json().catch(()=>({}));throw Error(o.error||"Erro ao buscar transportadoras")}let r=await a.json();return o({transportadoras:r,loading:!1}),r}catch(a){throw console.error("Erro ao buscar transportadoras:",a),o({loading:!1}),a}},addNota:async a=>{try{if(console.log("Dados sendo enviados:",a),!(await fetch("/api/auth/me",{credentials:"include"})).ok)throw Error("Usu\xe1rio n\xe3o autenticado");let r=await fetch("/api/addNota",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include",body:JSON.stringify(a)});if(console.log("Status da resposta:",r.status),401===r.status)throw window.dispatchEvent(new Event("unauthorized")),Error("Sess\xe3o expirada. Por favor, fa\xe7a login novamente.");if(!r.ok){let o;try{o=await r.json(),console.error("Detalhes do erro:",o)}catch(a){o=await r.text()}let a="object"==typeof o?o.error||o.message||"Erro desconhecido":o||"Erro ao processar a requisi\xe7\xe3o";throw Error("Erro ao salvar nota: ".concat(r.status," - ").concat(a))}let t=await r.json();return o(o=>({notas:[...o.notas,t],status:"success"})),t}catch(a){throw console.error("Erro ao adicionar nota:",a),o(o=>({...o,status:"error"})),(a.message.includes("n\xe3o autenticado")||a.message.includes("Sess\xe3o expirada"))&&window.dispatchEvent(new Event("unauthorized")),a}},criarControle:async a=>{try{var r,t;let e;if(console.log("[criarControle] Dados recebidos:",JSON.stringify(a,null,2)),!(null===(r=a.motorista)||void 0===r?void 0:r.trim()))throw Error("Nome do motorista \xe9 obrigat\xf3rio");if(!(null===(t=a.responsavel)||void 0===t?void 0:t.trim()))throw Error("Nome do respons\xe1vel \xe9 obrigat\xf3rio");if(console.log("[criarControle] Transportadora recebida:",a.transportadora),!["ACERT","EXPRESSO_GOIAS"].includes(a.transportadora))throw console.error("[criarControle] Transportadora inv\xe1lida:",a.transportadora),Error("Transportadora inv\xe1lida. Valor recebido: "+a.transportadora);let s=Array.isArray(a.notasIds)?a.notasIds:[],n={...a,motorista:a.motorista.trim(),responsavel:a.responsavel.trim(),cpfMotorista:a.cpfMotorista?a.cpfMotorista.replace(/[^\d]/g,""):"PENDENTE",qtdPallets:Number(a.qtdPallets)||0,observacao:a.observacao||null,notasIds:s};console.log("[criarControle] Dados formatados para envio:",JSON.stringify(n,null,2)),console.log("[criarControle] Enviando requisi\xe7\xe3o para /api/controles");let l=await fetch("/api/controles",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(n)});console.log("[criarControle] Resposta recebida. Status:",l.status);try{e=await l.json(),console.log("[criarControle] Corpo da resposta:",JSON.stringify(e,null,2))}catch(o){console.error("[criarControle] Erro ao fazer parse da resposta:",o),e={}}if(!l.ok){console.error("[criarControle] Erro na resposta da API. Status:",l.status),console.error("[criarControle] Dados do erro:",e);let o=e.error||e.message||"Erro ao criar controle: ".concat(l.status," ").concat(l.statusText);throw console.error("[criarControle] Mensagem de erro:",o),Error(o)}let i=e;if(s.length>0)try{let o=await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({controleId:i.id,notasIds:s})});if(!o.ok){let a=await o.json().catch(()=>({}));console.warn("Aviso ao vincular notas:",a)}i.notas=s.map(o=>({id:o}))}catch(o){console.error("Erro ao vincular notas:",o)}try{let a=await fetch("/api/controles",{credentials:"include",headers:{Accept:"application/json"}});if(a.ok){let r=await a.json();o({controles:r})}}catch(o){console.error("Erro ao atualizar lista de controles:",o)}return i}catch(o){if(console.error("Erro na fun\xe7\xe3o criarControle:",o),o instanceof Error)throw o;throw Error("Erro desconhecido ao criar controle")}},vincularNotas:async(o,a)=>{await fetch("/api/controles/vincular-notas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o,notasIds:a})}),await Promise.all([t.getState().fetchNotas(),t.getState().fetchControles()])},finalizarControle:async o=>{await fetch("/api/controles/finalizar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({controleId:o})}),await t.getState().fetchControles()},atualizarControle:async(o,a)=>{console.log("Iniciando atualizarControle...");try{console.log("Enviando requisi\xe7\xe3o para /api/controles/atualizar com dados:",{controleId:o,...a,qtdPallets:Number(a.qtdPallets)||0});let r=await fetch("/api/controles/atualizar",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({controleId:o,...a,qtdPallets:Number(a.qtdPallets)||0})});if(console.log("Resposta recebida, status:",r.status),!r.ok){console.error("Erro na resposta da API:",r.status,r.statusText);let o=await r.json().catch(()=>({}));throw console.error("Detalhes do erro:",o),Error(o.error||"Erro ao atualizar controle")}console.log("Atualizando lista de controles...");let e=await r.json();return await t.getState().fetchControles(),console.log("Controle atualizado com sucesso:",e),e}catch(o){return console.error("Erro ao atualizar controle:",o),null}}}))}}]);